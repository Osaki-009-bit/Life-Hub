<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Life-Hubï½œSchedule</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2e;
      --panel2:#0e1830;
      --text:#e9eefc;
      --muted:#a9b5d6;
      --line:rgba(255,255,255,.10);
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --accent:#3b82f6;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --btn:#2563eb;
      --btnHover:#1d4ed8;
      --chip:#1e2a46;
      --chipOn:#2b6ef6;
      --chipOn2:#16a34a;
      --today:#fbbf24;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1000px 600px at 10% 10%, rgba(59,130,246,.25), transparent 60%),
                  radial-gradient(900px 500px at 85% 20%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      min-height:100vh;
    }

    /* é¡¶éƒ¨æ ï¼ˆä¿æŒä½ ä¹ æƒ¯çš„ï¼šå·¦ä¾§æ ‡é¢˜/è¯´æ˜ + å³ä¾§åˆ‡æ¢ï¼‰ */
    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.86), rgba(11,18,32,.55));
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      font-weight:700;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
    }

    .mode-switch{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .seg{
      display:flex;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .seg button{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:8px 12px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
    }
    .seg button.active{
      background:rgba(59,130,246,.20);
      color:var(--text);
      box-shadow: 0 10px 18px rgba(59,130,246,.12);
    }

    .right-tools{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      padding:8px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:12px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .save-dot{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background:rgba(255,255,255,.25);
    }
    .dot.ok{background:rgba(34,197,94,.9)}
    .dot.warn{background:rgba(245,158,11,.95)}

    /* ä¸»å¸ƒå±€ï¼šå·¦åˆ—è¡¨ + å³ç¼–è¾‘åŒºï¼ˆä¿æŒä¸å˜ï¼‰ */
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px 26px;
    }
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(16,26,46,.55);
    }
    .panel-header .title{
      font-weight:800;
      font-size:13px;
      color:var(--text);
      letter-spacing:.2px;
    }
    .panel-body{padding:12px}

    /* å·¦ä¾§åˆ—è¡¨ */
    .list-controls{
      display:flex;
      gap:8px;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      transition:.15s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(37,99,235,.95), rgba(29,78,216,.95));
      border-color:rgba(59,130,246,.55);
      box-shadow:0 14px 24px rgba(37,99,235,.22);
    }
    .btn.danger{
      background:linear-gradient(180deg, rgba(239,68,68,.95), rgba(185,28,28,.95));
      border-color:rgba(239,68,68,.45);
      box-shadow:0 14px 24px rgba(239,68,68,.18);
    }

    .search{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    .search::placeholder{color:rgba(233,238,252,.55)}

    .items{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 70vh;
      overflow:auto;
      padding-right:4px;
    }
    .item{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 10px;
      cursor:pointer;
      transition:.15s ease;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .item:hover{transform: translateY(-1px); background:rgba(0,0,0,.24)}
    .item.active{
      border-color:rgba(59,130,246,.65);
      box-shadow:0 16px 24px rgba(59,130,246,.14);
      background:rgba(59,130,246,.10);
    }
    .badge{
      min-width:36px;
      height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
    .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1;
    }
    .meta .line1{
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .meta .name{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 210px;
    }
    .tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }
    .meta .line2{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }

    /* å³ä¾§ç¼–è¾‘åŒº */
    .form{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:980px){
      .row{grid-template-columns:1fr}
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin-bottom:6px;
    }
    .input, .textarea, .select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    .textarea{min-height:110px; resize:vertical}

    /* === é‡ç‚¹ä¿®å¤ï¼šæ—¥æœŸæŒ‰é’®é†’ç›® + ä½ç½®æ˜æ˜¾ === */
    .date-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid rgba(59,130,246,.35);
      background:linear-gradient(180deg, rgba(37,99,235,.18), rgba(37,99,235,.10));
      border-radius:16px;
      box-shadow:0 20px 36px rgba(37,99,235,.16);
    }
    .date-left{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .date-left .big{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .date-left .small{
      font-size:12px;
      color:rgba(233,238,252,.70);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .date-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .date-btn{
      border:1px solid rgba(59,130,246,.55);
      background:linear-gradient(180deg, rgba(37,99,235,.98), rgba(29,78,216,.98));
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
      box-shadow:0 18px 28px rgba(37,99,235,.26);
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .date-btn:hover{transform: translateY(-1px); filter:brightness(1.03)}
    .date-btn:active{transform: translateY(0)}
    .date-btn .spark{
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 0 0 6px rgba(255,255,255,.12);
    }
    .ghost-btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }

    /* æ—¶é—´ç‚¹å¤šé€‰ chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      user-select:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      transition:.12s ease;
    }
    .chip:hover{transform: translateY(-1px)}
    .chip.on{
      background:rgba(59,130,246,.22);
      border-color:rgba(59,130,246,.55);
      box-shadow:0 16px 20px rgba(59,130,246,.14);
    }

    /* æ¨¡å¼ä¸åŒï¼šæ¯”èµ›ç”¨ç»¿è‰²é«˜äº® */
    .mode-competition .seg button.active{background:rgba(34,197,94,.22)}
    .mode-competition .date-bar{border-color:rgba(34,197,94,.35); background:linear-gradient(180deg, rgba(34,197,94,.16), rgba(34,197,94,.08)); box-shadow:0 20px 36px rgba(34,197,94,.14)}
    .mode-competition .date-btn{border-color:rgba(34,197,94,.55); background:linear-gradient(180deg, rgba(22,163,74,.98), rgba(21,128,61,.98)); box-shadow:0 18px 28px rgba(34,197,94,.22)}
    .mode-competition .chip.on{background:rgba(34,197,94,.22); border-color:rgba(34,197,94,.55); box-shadow:0 16px 20px rgba(34,197,94,.14)}

    .hr{
      height:1px;
      background:var(--line);
      margin:6px 0;
    }

    /* === æ—¥å†æµ®çª—ï¼ˆModalï¼‰=== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:16px;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(16,26,46,.95), rgba(14,24,48,.95));
      box-shadow:0 30px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .modal-title{
      font-weight:1000;
      font-size:13px;
      color:var(--text);
    }
    .icon-btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .cal{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .cal-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .cal-top .nav{
      display:flex; gap:8px; align-items:center;
    }
    .cal-month{
      font-weight:1000;
      font-size:14px;
      letter-spacing:.3px;
    }
    .week{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      color:rgba(233,238,252,.70);
      font-weight:900;
      font-size:12px;
      padding:0 2px;
    }
    .grid-days{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .day{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px 0;
      text-align:center;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      transition:.12s ease;
      position:relative;
    }
    .day:hover{transform: translateY(-1px); background:rgba(255,255,255,.07)}
    .day.mute{
      opacity:.35;
      cursor:default;
    }
    .day.mute:hover{transform:none; background:rgba(255,255,255,.04)}
    .day.today::after{
      content:"";
      position:absolute;
      top:8px; right:10px;
      width:7px;height:7px;border-radius:99px;
      background:var(--today);
      box-shadow:0 0 0 5px rgba(251,191,36,.12);
    }
    .day.sel{
      border-color:rgba(59,130,246,.65);
      background:rgba(59,130,246,.20);
      box-shadow:0 18px 22px rgba(59,130,246,.18);
    }
    .mode-competition .day.sel{
      border-color:rgba(34,197,94,.65);
      background:rgba(34,197,94,.20);
      box-shadow:0 18px 22px rgba(34,197,94,.16);
    }

    .modal-foot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.16);
    }
    .hint{
      font-size:12px;
      color:rgba(233,238,252,.70);
    }

    /* å³ä¾§åº•éƒ¨æ“ä½œåŒº */
    .actions{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .mini{
      font-size:12px;
      color:rgba(233,238,252,.75);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <h1>Life-Hub Â· Schedule</h1>
        <div class="sub">å·¦ä¾§é€‰æ‹©æ¡ç›®ï¼Œå³ä¾§ç¼–è¾‘ï¼›è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰</div>
      </div>

      <div class="right-tools">
        <div class="seg" role="tablist" aria-label="mode">
          <button id="modeCourse" class="active" type="button" role="tab" aria-selected="true">è¯¾ç¨‹</button>
          <button id="modeComp" type="button" role="tab" aria-selected="false">æ¯”èµ›</button>
        </div>

        <div class="pill save-dot" title="è‡ªåŠ¨ä¿å­˜çŠ¶æ€">
          <span id="saveDot" class="dot ok"></span>
          <span id="saveText">å·²ä¿å­˜</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- å·¦ä¾§åˆ—è¡¨ -->
      <div class="panel">
        <div class="panel-header">
          <div class="title">æ¡ç›®åˆ—è¡¨</div>
          <div class="list-controls">
            <button id="addBtn" class="btn primary" type="button">+ æ–°å»º</button>
            <button id="delBtn" class="btn danger" type="button">åˆ é™¤</button>
          </div>
        </div>
        <div class="panel-body">
          <input id="search" class="search" placeholder="æœç´¢ï¼šåç§° / å¤‡æ³¨ / æ—¥æœŸâ€¦" />
          <div class="hr"></div>
          <div id="items" class="items"></div>
        </div>
      </div>

      <!-- å³ä¾§ç¼–è¾‘åŒº -->
      <div class="panel">
        <div class="panel-header">
          <div class="title" id="editorTitle">ç¼–è¾‘åŒº</div>
          <div class="mini" id="editorSub">é€‰æ‹©ä¸€ä¸ªæ¡ç›®å¼€å§‹ç¼–è¾‘</div>
        </div>
        <div class="panel-body">
          <div class="form" id="form" style="display:none;">
            <!-- æœˆä»½ + æ—¥æœŸæŒ‰é’®ï¼ˆé†’ç›®ï¼‰ -->
            <div class="row">
              <div>
                <label>æœˆä»½</label>
                <select id="monthSel" class="select"></select>
              </div>

              <!-- æ—¥æœŸå±•ç¤º + å¼ºåŒ–æŒ‰é’®ï¼ˆæ›´æ˜¾çœ¼ + é ä¸Šï¼‰ -->
              <div>
                <label>æ—¥æœŸ</label>
                <div class="date-bar">
                  <div class="date-left">
                    <div class="big" id="dateBig">æœªé€‰æ‹©æ—¥æœŸ</div>
                    <div class="small" id="dateSmall">ç‚¹å‡»å³ä¾§æŒ‰é’®é€‰æ‹©ï¼ˆä¼šå¼¹å‡ºæ—¥å†ï¼‰</div>
                  </div>
                  <div class="date-actions">
                    <button id="pickDateBtn" class="date-btn" type="button">
                      <span class="spark"></span>
                      é€‰æ‹©æ—¥æœŸ
                    </button>
                    <button id="todayBtn" class="ghost-btn" type="button">ä»Šå¤©</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- è¯¾ç¨‹/æ¯”èµ›åç§°ï¼ˆæ¯”èµ›ï¼šæŸæŸæ˜¯è¾“å…¥æ¡†ï¼Œæ¯”èµ›æ˜¯ç•Œé¢æ–‡å­—è‡ªåŠ¨æ˜¾ç¤ºï¼‰ -->
            <div class="row">
              <div>
                <label id="nameLabel">è¯¾ç¨‹åç§°</label>
                <input id="nameInput" class="input" placeholder="ä¾‹å¦‚ï¼šMath / ELL / Basketballâ€¦" list="nameHistory" />
                <datalist id="nameHistory"></datalist>
              </div>
              <div>
                <label>ç±»å‹</label>
                <input id="typeReadonly" class="input" readonly />
              </div>
            </div>

            <!-- æ—¶é—´ç‚¹å¤šé€‰ -->
            <div>
              <label>æ—¶é—´ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰</label>
              <div id="chips" class="chips"></div>
              <div class="mini" style="margin-top:6px;color:rgba(233,238,252,.65)">æç¤ºï¼šç‚¹å‡»å¯é€‰ä¸­/å–æ¶ˆé€‰ä¸­ï¼Œä¼šé«˜äº®ä¿å­˜</div>
            </div>

            <div class="row">
              <div>
                <label>åœ°ç‚¹</label>
                <input id="locInput" class="input" placeholder="ä¾‹å¦‚ï¼šLangley Event Center / Schoolâ€¦" />
              </div>
              <div>
                <label>å¤‡æ³¨æ ‡ç­¾</label>
                <input id="tagInput" class="input" placeholder="ä¾‹å¦‚ï¼šé‡è¦ / éœ€å‡†å¤‡ / å¸¦æ°´â€¦" />
              </div>
            </div>

            <div>
              <label>å¤‡æ³¨</label>
              <textarea id="noteInput" class="textarea" placeholder="å†™ä¸‹è¦å¸¦çš„ä¸œè¥¿ã€æ³¨æ„äº‹é¡¹ã€æ¯”èµ›å¯¹æ‰‹ã€é›†åˆæ—¶é—´â€¦"></textarea>
            </div>

            <div class="actions">
              <button id="dupBtn" class="btn" type="button">å¤åˆ¶æ¡ç›®</button>
              <button id="clearBtn" class="btn" type="button">æ¸…ç©ºæœ¬æ¡å¡«å†™</button>
            </div>
          </div>

          <div id="empty" class="mini" style="color:rgba(233,238,252,.70);">
            ä½ è¿˜æ²¡æœ‰é€‰æ‹©æ¡ç›®ã€‚å·¦ä¾§ç‚¹ä¸€ä¸ªï¼Œæˆ–ç‚¹â€œ+ æ–°å»ºâ€ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ—¥å†æµ®çª—ï¼ˆModalï¼‰ -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="é€‰æ‹©æ—¥æœŸ">
      <div class="modal-head">
        <div class="modal-title">é€‰æ‹©æ—¥æœŸ</div>
        <button id="closeModal" class="icon-btn" type="button">å…³é—­</button>
      </div>

      <div class="cal">
        <div class="cal-top">
          <div class="nav">
            <button id="prevMonth" class="icon-btn" type="button">â—€</button>
            <button id="nextMonth" class="icon-btn" type="button">â–¶</button>
          </div>
          <div class="cal-month" id="calMonthText">â€”</div>
          <button id="goToday" class="icon-btn" type="button">ä»Šå¤©</button>
        </div>

        <div class="week">
          <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
        </div>

        <div id="calGrid" class="grid-days"></div>
      </div>

      <div class="modal-foot">
        <div class="hint" id="calHint">ç‚¹å‡»æŸä¸€å¤©å³å¯é€‰ä¸­å¹¶å…³é—­</div>
        <button id="cancelModal" class="icon-btn" type="button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

<script>
/**
 * Life-Hub schedule.htmlï¼ˆå•æ–‡ä»¶ç‰ˆï¼‰
 * ä¿®å¤ç‚¹ï¼š
 * 1) â€œé€‰æ‹©æ—¥æœŸâ€ä¸€å®šå¼¹å‡ºè‡ªå®šä¹‰æ—¥å†æµ®çª—ï¼ˆä¸ä¾èµ– input[type=date]ï¼Œé¿å…æµè§ˆå™¨/æ ·å¼å¯¼è‡´ä¸å¼¹ï¼‰
 * 2) æ—¥æœŸæŒ‰é’®æ›´é†’ç›®ï¼šé¢œè‰²æ›´å¼º + æ”¾åˆ°ç¼–è¾‘åŒºæ›´é ä¸Š + å¤§å¡ç‰‡å¼ date-bar
 *
 * æ•°æ®å­˜å‚¨ï¼šlocalStorageï¼ˆå®Œå…¨ç¦»çº¿ï¼‰
 */

(function(){
  const LS_KEY = "lifehub_schedule_v3";
  const LS_UI  = "lifehub_schedule_ui_v3";

  // ====== DOM ======
  const body = document.body;

  const modeCourse = document.getElementById("modeCourse");
  const modeComp   = document.getElementById("modeComp");

  const saveDot  = document.getElementById("saveDot");
  const saveText = document.getElementById("saveText");

  const addBtn = document.getElementById("addBtn");
  const delBtn = document.getElementById("delBtn");
  const dupBtn = document.getElementById("dupBtn");
  const clearBtn = document.getElementById("clearBtn");

  const search = document.getElementById("search");
  const itemsEl = document.getElementById("items");

  const form = document.getElementById("form");
  const empty = document.getElementById("empty");

  const editorTitle = document.getElementById("editorTitle");
  const editorSub = document.getElementById("editorSub");

  const monthSel = document.getElementById("monthSel");
  const pickDateBtn = document.getElementById("pickDateBtn");
  const todayBtn = document.getElementById("todayBtn");

  const dateBig = document.getElementById("dateBig");
  const dateSmall = document.getElementById("dateSmall");

  const nameLabel = document.getElementById("nameLabel");
  const nameInput = document.getElementById("nameInput");
  const nameHistory = document.getElementById("nameHistory");

  const typeReadonly = document.getElementById("typeReadonly");
  const locInput = document.getElementById("locInput");
  const tagInput = document.getElementById("tagInput");
  const noteInput = document.getElementById("noteInput");

  const chipsEl = document.getElementById("chips");

  // Modal Calendar
  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModal = document.getElementById("closeModal");
  const cancelModal = document.getElementById("cancelModal");
  const prevMonth = document.getElementById("prevMonth");
  const nextMonth = document.getElementById("nextMonth");
  const goToday = document.getElementById("goToday");
  const calMonthText = document.getElementById("calMonthText");
  const calGrid = document.getElementById("calGrid");
  const calHint = document.getElementById("calHint");

  // ====== State ======
  const TIME_CHIPS = ["æ—©ä¸Š", "ä¸Šåˆ", "ä¸­åˆ", "ä¸‹åˆ", "å‚æ™š", "æ™šä¸Š", "å…¨å¤©"];
  let state = loadData();
  let ui = loadUI();

  let currentId = ui.currentId || null;
  let currentMode = ui.mode || "course"; // "course" | "competition"

  // Calendar view month for modal
  let calView = new Date(); // will be synced when opening modal

  // ====== Init ======
  renderMode();
  buildMonthSelect();
  buildChips();
  renderList();
  selectInitial();
  wire();

  // ====== Wire events ======
  function wire(){
    modeCourse.addEventListener("click", ()=>setMode("course"));
    modeComp.addEventListener("click", ()=>setMode("competition"));

    addBtn.addEventListener("click", addItem);
    delBtn.addEventListener("click", deleteCurrent);
    dupBtn.addEventListener("click", duplicateCurrent);
    clearBtn.addEventListener("click", clearCurrentFields);

    search.addEventListener("input", renderList);

    monthSel.addEventListener("change", ()=>{
      if(!currentId) return;
      const m = monthSel.value; // "YYYY-MM"
      patchCurrent({ month: m });
      // å¦‚æœå½“å‰æ—¥æœŸä¸åœ¨è¯¥æœˆï¼Œä¿æŒåŸæ—¥æœŸä½†æœˆä»½å±•ç¤ºä»æŒ‰ month å­—æ®µ
      renderEditor();
      softSave();
    });

    // === å…³é”®ï¼šæŒ‰é’® -> å¼¹å‡ºæ—¥å†æµ®çª—ï¼ˆä¿®å¤ #1ï¼‰ ===
    pickDateBtn.addEventListener("click", ()=>{
      if(!currentId) return;
      openCalendarModal();
    });

    todayBtn.addEventListener("click", ()=>{
      if(!currentId) return;
      const d = new Date();
      applyDate(d);
    });

    // inputs autosave
    const onInput = ()=>{ if(!currentId) return; softSave(); };
    nameInput.addEventListener("input", ()=>{
      if(!currentId) return;
      patchCurrent({ name: nameInput.value.trim() });
      updateNameHistory();
      onInput();
      renderList(); // åç§°å˜åŠ¨ç«‹å³åæ˜ å·¦ä¾§
    });
    locInput.addEventListener("input", ()=>{
      if(!currentId) return;
      patchCurrent({ location: locInput.value });
      onInput();
      renderList();
    });
    tagInput.addEventListener("input", ()=>{
      if(!currentId) return;
      patchCurrent({ tag: tagInput.value });
      onInput();
      renderList();
    });
    noteInput.addEventListener("input", ()=>{
      if(!currentId) return;
      patchCurrent({ note: noteInput.value });
      onInput();
      renderList();
    });

    // Modal interactions
    closeModal.addEventListener("click", closeCalendarModal);
    cancelModal.addEventListener("click", closeCalendarModal);
    modalBackdrop.addEventListener("click", (e)=>{
      if(e.target === modalBackdrop) closeCalendarModal();
    });
    document.addEventListener("keydown", (e)=>{
      if(!modalBackdrop.classList.contains("show")) return;
      if(e.key === "Escape") closeCalendarModal();
    });

    prevMonth.addEventListener("click", ()=>{
      calView = new Date(calView.getFullYear(), calView.getMonth()-1, 1);
      renderCalendar();
    });
    nextMonth.addEventListener("click", ()=>{
      calView = new Date(calView.getFullYear(), calView.getMonth()+1, 1);
      renderCalendar();
    });
    goToday.addEventListener("click", ()=>{
      calView = new Date();
      renderCalendar();
    });
  }

  // ====== Mode ======
  function setMode(m){
    currentMode = m;
    ui.mode = m;
    saveUI();

    renderMode();
    renderList();
    renderEditor();
  }

  function renderMode(){
    const isCourse = currentMode === "course";
    modeCourse.classList.toggle("active", isCourse);
    modeCourse.setAttribute("aria-selected", String(isCourse));
    modeComp.classList.toggle("active", !isCourse);
    modeComp.setAttribute("aria-selected", String(!isCourse));

    body.classList.toggle("mode-competition", !isCourse);

    // editor labels
    nameLabel.textContent = isCourse ? "è¯¾ç¨‹åç§°" : "æŸæŸï¼ˆè¾“å…¥ï¼‰";
    typeReadonly.value = isCourse ? "è¯¾ç¨‹" : "æ¯”èµ›";
    editorTitle.textContent = isCourse ? "è¯¾ç¨‹ç¼–è¾‘" : "æ¯”èµ›ç¼–è¾‘";
  }

  // ====== Data helpers ======
  function loadData(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { items: [] };
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.items)) return { items: [] };
      return obj;
    }catch(e){
      return { items: [] };
    }
  }
  function saveData(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }
  function loadUI(){
    try{
      const raw = localStorage.getItem(LS_UI);
      if(!raw) return {};
      return JSON.parse(raw) || {};
    }catch(e){ return {}; }
  }
  function saveUI(){
    localStorage.setItem(LS_UI, JSON.stringify(ui));
  }

  function uid(){
    return "i_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function getCurrent(){
    return state.items.find(x=>x.id===currentId) || null;
  }

  function patchCurrent(patch){
    const idx = state.items.findIndex(x=>x.id===currentId);
    if(idx < 0) return;
    state.items[idx] = {
      ...state.items[idx],
      ...patch,
      updatedAt: Date.now()
    };
  }

  // ====== Build UI parts ======
  function buildMonthSelect(){
    monthSel.innerHTML = "";
    // build 24 months centered around current month
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth()-6, 1);
    for(let i=0;i<24;i++){
      const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const v = `${y}-${m}`;
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = `${y}å¹´${Number(m)}æœˆ`;
      monthSel.appendChild(opt);
    }
  }

  function buildChips(){
    chipsEl.innerHTML = "";
    TIME_CHIPS.forEach(t=>{
      const el = document.createElement("div");
      el.className = "chip";
      el.textContent = t;
      el.addEventListener("click", ()=>{
        if(!currentId) return;
        const cur = getCurrent();
        const set = new Set(cur.times || []);
        if(set.has(t)) set.delete(t); else set.add(t);
        patchCurrent({ times: Array.from(set) });
        renderEditor();
        softSave();
        renderList();
      });
      chipsEl.appendChild(el);
    });
  }

  // ====== List render ======
  function renderList(){
    const q = (search.value || "").trim().toLowerCase();

    // filter by currentMode type
    const type = currentMode; // course/competition
    let arr = state.items.filter(it=>it.type===type);

    // search
    if(q){
      arr = arr.filter(it=>{
        const blob = `${it.name||""} ${it.note||""} ${it.location||""} ${it.tag||""} ${it.date||""} ${it.month||""}`.toLowerCase();
        return blob.includes(q);
      });
    }

    // sort: date desc then updatedAt desc
    arr.sort((a,b)=>{
      const ad = a.date || "";
      const bd = b.date || "";
      if(ad !== bd) return bd.localeCompare(ad);
      return (b.updatedAt||0) - (a.updatedAt||0);
    });

    itemsEl.innerHTML = "";
    if(arr.length === 0){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.style.padding = "8px 4px";
      empty.style.color = "rgba(233,238,252,.70)";
      empty.textContent = q ? "æ²¡æœ‰åŒ¹é…çš„æ¡ç›®ã€‚" : "è¿˜æ²¡æœ‰æ¡ç›®ï¼Œç‚¹â€œ+ æ–°å»ºâ€ã€‚";
      itemsEl.appendChild(empty);
      return;
    }

    arr.forEach(it=>{
      const div = document.createElement("div");
      div.className = "item" + (it.id===currentId ? " active" : "");
      div.addEventListener("click", ()=>{
        currentId = it.id;
        ui.currentId = currentId;
        saveUI();
        renderList();
        renderEditor();
      });

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = (it.date ? it.date.slice(-2) : "â€”");

      const meta = document.createElement("div");
      meta.className = "meta";

      const line1 = document.createElement("div");
      line1.className = "line1";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = it.name || (it.type==="competition" ? "ï¼ˆæœªå‘½åæ¯”èµ›ï¼‰" : "ï¼ˆæœªå‘½åè¯¾ç¨‹ï¼‰");

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = it.month ? it.month : "æœªé€‰æœˆä»½";

      line1.appendChild(name);
      line1.appendChild(tag);

      const line2 = document.createElement("div");
      line2.className = "line2";
      const t = (it.times && it.times.length) ? ` Â· ${it.times.join(" / ")}` : "";
      const loc = it.location ? ` Â· ${it.location}` : "";
      const dd = it.date ? `ğŸ“… ${formatDateCN(it.date)}` : "ğŸ“… æœªé€‰æ—¥æœŸ";
      line2.textContent = `${dd}${t}${loc}`;

      meta.appendChild(line1);
      meta.appendChild(line2);

      div.appendChild(badge);
      div.appendChild(meta);
      itemsEl.appendChild(div);
    });
  }

  // ====== Editor ======
  function selectInitial(){
    // If currentId invalid or not in current mode, try pick first item in mode
    if(currentId && state.items.some(x=>x.id===currentId && x.type===currentMode)){
      renderEditor();
      return;
    }
    const first = state.items.find(x=>x.type===currentMode);
    if(first){
      currentId = first.id;
      ui.currentId = currentId;
      saveUI();
      renderEditor();
    }else{
      currentId = null;
      ui.currentId = null;
      saveUI();
      renderEditor();
    }
  }

  function renderEditor(){
    const it = getCurrent();
    const show = !!it;

    form.style.display = show ? "flex" : "none";
    empty.style.display = show ? "none" : "block";
    editorSub.textContent = show ? "ä¿®æ”¹ä¼šè‡ªåŠ¨ä¿å­˜" : "é€‰æ‹©ä¸€ä¸ªæ¡ç›®å¼€å§‹ç¼–è¾‘";

    if(!show) return;

    // mode-based readonly type
    typeReadonly.value = (currentMode==="course") ? "è¯¾ç¨‹" : "æ¯”èµ›";

    // month
    if(!it.month){
      // default month = current month
      const d = new Date();
      const v = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      patchCurrent({ month: v });
    }
    monthSel.value = it.month;

    // name/loc/tag/note
    nameInput.value = it.name || "";
    locInput.value = it.location || "";
    tagInput.value = it.tag || "";
    noteInput.value = it.note || "";

    // date display
    if(it.date){
      dateBig.textContent = formatDateCN(it.date);
      dateSmall.textContent = "ç‚¹å‡»å³ä¾§æŒ‰é’®å¯é‡æ–°é€‰æ‹©";
    }else{
      dateBig.textContent = "æœªé€‰æ‹©æ—¥æœŸ";
      dateSmall.textContent = "ç‚¹å‡»å³ä¾§â€œé€‰æ‹©æ—¥æœŸâ€ï¼Œä¼šå¼¹å‡ºæ—¥å†æµ®çª—";
    }

    // chips selected
    const set = new Set(it.times || []);
    [...chipsEl.children].forEach(ch=>{
      ch.classList.toggle("on", set.has(ch.textContent));
    });

    updateNameHistory();
  }

  function updateNameHistory(){
    // build datalist from unique names in same mode
    const names = Array.from(new Set(
      state.items.filter(x=>x.type===currentMode).map(x=>(x.name||"").trim()).filter(Boolean)
    )).slice(0,50);

    nameHistory.innerHTML = "";
    names.forEach(n=>{
      const opt = document.createElement("option");
      opt.value = n;
      nameHistory.appendChild(opt);
    });
  }

  // ====== Actions ======
  function addItem(){
    const now = new Date();
    const month = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
    const item = {
      id: uid(),
      type: currentMode,               // course / competition
      month,
      date: "",                        // YYYY-MM-DD
      name: "",
      times: [],
      location: "",
      tag: "",
      note: "",
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    state.items.unshift(item);
    currentId = item.id;
    ui.currentId = currentId;
    saveUI();
    hardSave();
    renderList();
    renderEditor();
  }

  function deleteCurrent(){
    if(!currentId) return;
    const it = getCurrent();
    if(!it) return;

    const ok = confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ¡ç›®å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚");
    if(!ok) return;

    state.items = state.items.filter(x=>x.id!==currentId);
    currentId = null;
    ui.currentId = null;
    saveUI();
    hardSave();
    renderList();
    selectInitial();
  }

  function duplicateCurrent(){
    const it = getCurrent();
    if(!it) return;
    const copy = JSON.parse(JSON.stringify(it));
    copy.id = uid();
    copy.createdAt = Date.now();
    copy.updatedAt = Date.now();
    // å¤åˆ¶åæ”¾åˆ°æœ€å‰å¹¶é€‰ä¸­
    state.items.unshift(copy);
    currentId = copy.id;
    ui.currentId = currentId;
    saveUI();
    hardSave();
    renderList();
    renderEditor();
  }

  function clearCurrentFields(){
    const it = getCurrent();
    if(!it) return;
    const ok = confirm("æ¸…ç©ºæœ¬æ¡å¡«å†™ï¼ˆåç§°/æ—¶é—´ç‚¹/åœ°ç‚¹/æ ‡ç­¾/å¤‡æ³¨/æ—¥æœŸï¼‰ï¼Ÿ");
    if(!ok) return;

    patchCurrent({
      date:"",
      name:"",
      times:[],
      location:"",
      tag:"",
      note:""
    });
    hardSave();
    renderList();
    renderEditor();
  }

  // ====== Save status ======
  let saveTimer = null;

  function softSave(){
    // show pending
    setSaving(true);
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      hardSave();
    }, 300);
  }

  function hardSave(){
    saveData();
    setSaving(false);
  }

  function setSaving(isSaving){
    if(isSaving){
      saveDot.classList.remove("ok");
      saveDot.classList.add("warn");
      saveText.textContent = "ä¿å­˜ä¸­â€¦";
    }else{
      saveDot.classList.remove("warn");
      saveDot.classList.add("ok");
      saveText.textContent = "å·²ä¿å­˜";
    }
  }

  // ====== Calendar modal (Fix #1) ======
  function openCalendarModal(){
    const it = getCurrent();
    if(!it) return;

    // Sync calView to item.date or item.month or today
    if(it.date){
      calView = parseYMD(it.date) || new Date();
    }else if(it.month){
      const parts = it.month.split("-");
      calView = new Date(Number(parts[0]), Number(parts[1])-1, 1);
    }else{
      calView = new Date();
    }

    modalBackdrop.classList.add("show");
    modalBackdrop.setAttribute("aria-hidden","false");
    renderCalendar();
  }

  function closeCalendarModal(){
    modalBackdrop.classList.remove("show");
    modalBackdrop.setAttribute("aria-hidden","true");
  }

  function renderCalendar(){
    const y = calView.getFullYear();
    const m = calView.getMonth(); // 0-11

    calMonthText.textContent = `${y}å¹´${m+1}æœˆ`;

    // Build grid for month
    const first = new Date(y, m, 1);
    const firstDay = first.getDay(); // 0 Sun
    const daysInMonth = new Date(y, m+1, 0).getDate();

    // selection for current item
    const it = getCurrent();
    const sel = it && it.date ? it.date : "";
    const selD = sel ? parseYMD(sel) : null;

    // today
    const today = new Date();
    const tY = today.getFullYear(), tM = today.getMonth(), tD = today.getDate();

    calGrid.innerHTML = "";

    // leading blanks
    for(let i=0;i<firstDay;i++){
      const d = document.createElement("div");
      d.className = "day mute";
      d.textContent = "";
      calGrid.appendChild(d);
    }

    for(let dNum=1; dNum<=daysInMonth; dNum++){
      const cell = document.createElement("div");
      cell.className = "day";
      cell.textContent = dNum;

      const isToday = (y===tY && m===tM && dNum===tD);
      if(isToday) cell.classList.add("today");

      const isSel = selD && (selD.getFullYear()===y && selD.getMonth()===m && selD.getDate()===dNum);
      if(isSel) cell.classList.add("sel");

      cell.addEventListener("click", ()=>{
        // click date => apply and close
        const chosen = new Date(y, m, dNum);
        applyDate(chosen);
        closeCalendarModal();
      });

      calGrid.appendChild(cell);
    }

    const hintMode = (currentMode==="course") ? "è¯¾ç¨‹" : "æ¯”èµ›";
    calHint.textContent = `ç‚¹å‡»æŸä¸€å¤©å³å¯é€‰ä¸­å¹¶å…³é—­ï¼ˆå½“å‰ï¼š${hintMode}ï¼‰`;
  }

  function applyDate(dateObj){
    if(!currentId) return;
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth()+1).padStart(2,"0");
    const d = String(dateObj.getDate()).padStart(2,"0");
    const ymd = `${y}-${m}-${d}`;
    const month = `${y}-${m}`;

    patchCurrent({ date: ymd, month });

    // sync month select
    monthSel.value = month;
    renderEditor();
    renderList();
    softSave();
  }

  // ====== Utils ======
  function parseYMD(ymd){
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd);
    if(!m) return null;
    const y = Number(m[1]);
    const mo = Number(m[2]) - 1;
    const d = Number(m[3]);
    const dt = new Date(y, mo, d);
    if(dt.getFullYear()!==y || dt.getMonth()!==mo || dt.getDate()!==d) return null;
    return dt;
  }

  function formatDateCN(ymd){
    const dt = parseYMD(ymd);
    if(!dt) return ymd;
    const y = dt.getFullYear();
    const m = dt.getMonth()+1;
    const d = dt.getDate();
    const w = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][dt.getDay()];
    return `${y}å¹´${m}æœˆ${d}æ—¥ï¼ˆå‘¨${w}ï¼‰`;
  }

})();
</script>
</body>
</html>
