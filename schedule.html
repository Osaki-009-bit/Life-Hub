<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç”Ÿæ´»ä¸­å¿ƒï½œè¯¾ç¨‹ä¸æ¯”èµ›</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --line:#e6ebf2;
      --primary:#2563eb;     /* è“ */
      --danger:#ef4444;      /* çº¢ */
      --shadow: 0 10px 30px rgba(16, 24, 40, .08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Noto Sans CJK SC","Microsoft YaHei",Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width: 1180px;
      margin: 18px auto;
      padding: 0 14px 24px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .title{
      display:flex; align-items:center; gap:10px;
    }
    .title h1{
      margin:0;
      font-size: 20px;
      letter-spacing:.2px;
    }
    .tabs{
      display:flex; gap:8px;
      background:#f1f5ff;
      border:1px solid #dbe7ff;
      padding:6px;
      border-radius: 999px;
    }
    .tabbtn{
      border:none;
      background:transparent;
      padding:8px 12px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
      color:#2453c9;
    }
    .tabbtn.active{
      background: var(--primary);
      color:#fff;
      box-shadow: 0 6px 18px rgba(37,99,235,.25);
    }
    .actions{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      background: var(--primary);
      color:#fff;
      box-shadow: 0 8px 22px rgba(37,99,235,.25);
      white-space:nowrap;
    }
    .btn.secondary{
      background:#ffffff;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
    }

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHead .hint{
      color:var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    /* å·¦ä¾§åˆ—è¡¨ */
    .list{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 68vh;
      overflow:auto;
    }
    .cardItem{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      background: #fff;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease;
    }
    .cardItem:hover{ border-color:#cdd9ee; }
    .cardItem.active{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,.14);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius:999px;
      font-size: 12px;
      font-weight:800;
      border:1px solid var(--line);
      background:#f8fafc;
      color:#334155;
    }
    .badge.course{ background:#ecf3ff; border-color:#d7e6ff; color:#1d4ed8; }
    .badge.match{ background:#fff1f2; border-color:#ffe4e6; color:#be123c; }

    .itemTitle{
      margin: 8px 0 2px;
      font-size: 18px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .itemSub{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 6px;
    }

    /* å³ä¾§è¯¦æƒ… */
    .detail{
      padding: 16px;
    }
    .empty{
      padding: 28px 16px;
      color: var(--muted);
      text-align:center;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 680px){
      .row{grid-template-columns:1fr;}
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      font-weight:700;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color:#b7cdfd;
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }
    .inline{
      display:flex; gap:10px; align-items:center;
    }
    .inline .fixedWord{
      font-weight:900;
      font-size: 18px;
      white-space:nowrap;
    }

    .infoBox{
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#f8fbff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .infoBox .left{
      display:flex;
      gap:10px;
      align-items:center;
      color:#1144c7;
      font-weight:800;
      font-size: 13px;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--primary);
      color:#fff;
      font-weight:900;
      font-size: 12px;
    }

    .dangerPill{
      background: var(--danger);
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .btn.small{
      padding: 10px 12px;
      border-radius: 12px;
      font-weight:900;
    }

    /* æ—¥å†å¼¹çª— */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(15, 23, 42, .55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalMask.show{ display:flex; }
    .modal{
      width:min(980px, 100%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 22px 80px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
    }
    .modalTop .modalTitle{
      font-weight: 1000;
      font-size: 18px;
    }
    .modalTop .close{
      border:none;
      background:transparent;
      font-size: 22px;
      cursor:pointer;
      color:#64748b;
    }
    .modalHint{
      padding: 12px 16px;
      background: var(--primary);
      color:#fff;
      font-weight:900;
      text-align:center;
    }
    .calHead{
      display:grid;
      grid-template-columns: 50px 1fr 50px;
      align-items:center;
      padding: 14px 16px 8px;
      gap: 10px;
    }
    .calHead .navBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size: 22px;
      color:#1e40af;
      font-weight:900;
    }
    .calHead .ym{
      text-align:center;
      font-weight:1000;
      letter-spacing:.5px;
    }

    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      padding: 0 16px 6px;
      gap: 8px;
      color: #94a3b8;
      font-size: 12px;
      font-weight:800;
    }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      padding: 10px 16px 18px;
    }
    .dayCell{
      position:relative;
      border:1px solid transparent;
      border-radius: 12px;
      min-height: 54px;
      padding: 10px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      cursor:pointer;
      user-select:none;
      background:#fff;
      transition: transform .05s ease, background .12s ease, border-color .12s ease;
    }
    .dayCell:hover{ border-color:#dbeafe; background:#f8fbff; }
    .dayNum{
      font-weight: 1000;
      font-size: 14px;
      color:#0f172a;
    }
    .dayCell.muted .dayNum{ color:#cbd5e1; }
    /* é€‰ä¸­/æ ‡è®°ï¼šæ”¹ä¸ºâ€œè‰²å—é«˜äº®â€ï¼ˆæ»¡è¶³ä¿®æ”¹2ï¼‰ */
    .dayCell.selectedBlue{
      background: var(--primary);
      border-color: var(--primary);
    }
    .dayCell.selectedBlue .dayNum{ color:#fff; }
    .dayCell.selectedRed{
      background: var(--danger);
      border-color: var(--danger);
    }
    .dayCell.selectedRed .dayNum{ color:#fff; }

    .modalBottom{
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
    }
    .modalBottom .summary{
      color:#334155;
      font-weight:800;
      font-size: 13px;
    }
    .bigConfirm{
      width: 100%;
      border:none;
      background: var(--primary);
      color:#fff;
      font-weight:1000;
      padding: 14px 16px;
      font-size: 14px;
      cursor:pointer;
      border-radius: 14px;
      box-shadow: 0 10px 26px rgba(37,99,235,.25);
    }
    .bigConfirm:active{ transform: translateY(1px); }

    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top: 6px;
      line-height: 1.5;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>ç”Ÿæ´»ä¸­å¿ƒ</h1>
      </div>

      <div class="tabs" role="tablist" aria-label="åˆ‡æ¢ç±»å‹">
        <button class="tabbtn active" id="tabCourse" type="button">å¸¸è§„å‘¨æœŸï¼ˆè¯¾ç¨‹ï¼‰</button>
        <button class="tabbtn" id="tabMatch" type="button">æ¯”èµ›å˜åŠ¨ï¼ˆæ¯”èµ›ï¼‰</button>
      </div>

      <div class="actions">
        <button class="btn secondary" id="btnExport" type="button">å¯¼å‡ºå¤‡ä»½</button>
        <button class="btn" id="btnAdd" type="button">æ–°å¢</button>
      </div>
    </div>

    <div class="grid">
      <!-- å·¦ï¼šåˆ—è¡¨ -->
      <div class="panel">
        <div class="panelHead">
          <div>
            <div style="font-weight:1000;">æ¡ç›®åˆ—è¡¨</div>
            <div class="hint">ç‚¹å‡»æ¡ç›®è¿›è¡Œç¼–è¾‘ä¸æŸ¥çœ‹ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰</div>
          </div>
          <button class="btn secondary small" id="btnDelete" type="button" disabled>åˆ é™¤</button>
        </div>
        <div class="list" id="itemList"></div>
      </div>

      <!-- å³ï¼šè¯¦æƒ… -->
      <div class="panel">
        <div class="panelHead">
          <div>
            <div style="font-weight:1000;">ç¼–è¾‘åŒº</div>
            <div class="hint">æ—¥æœŸ/æ—¶é—´/æœˆä»½èŒƒå›´éƒ½æ”¯æŒâ€œç‚¹é€‰â€ï¼Œå‡å°‘è¾“å…¥</div>
          </div>
          <button class="btn secondary small" id="btnClear" type="button">æ¸…ç©ºæœ¬æœºæ•°æ®</button>
        </div>
        <div class="detail" id="detailArea">
          <div class="empty">è¯·é€‰æ‹©å·¦ä¾§ä¸€ä¸ªæ¡ç›®ï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’â€œæ–°å¢â€ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ—¥å†å¼¹çª— -->
  <div class="modalMask" id="modalMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">å¤šé€‰ä¸Šè¯¾æ—¥æœŸ</div>
        <button class="close" id="modalClose" type="button">Ã—</button>
      </div>
      <div class="modalHint">è¯·ç‚¹å‡»ä¸‹æ–¹æ—¥æœŸè¿›è¡Œé€‰æ‹© / å–æ¶ˆï¼ˆå·²é€‰æ—¥æœŸä¼šé«˜äº®ï¼‰</div>

      <!-- ä¿®æ”¹1ï¼šæ˜¾ç¤ºå¹´/æœˆï¼›å¯åˆ‡æ¢ -->
      <div class="calHead">
        <button class="navBtn" id="prevMonth" type="button">â—€</button>
        <div class="ym" id="ymLabel">2026 / 01</div>
        <button class="navBtn" id="nextMonth" type="button">â–¶</button>
      </div>

      <div class="dow">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
      </div>
      <div class="calGrid" id="calGrid"></div>

      <div class="modalBottom">
        <div class="summary" id="calSummary">å·²é€‰ 0 å¤©</div>
        <button class="bigConfirm" id="calConfirm" type="button">ç¡®è®¤é€‰æ‹©</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * æ•°æ®ç»“æ„
     ***********************/
    const STORAGE_KEY = "lifehub_schedule_v2";

    // type: "course" | "match"
    // title: è¯¾ç¨‹/æ¯”èµ›åç§°ï¼ˆè¯¾ç¨‹ï¼šå®Œæ•´æ ‡é¢˜ï¼›æ¯”èµ›ï¼šåªå­˜â€œæŸæŸâ€ï¼Œæ˜¾ç¤ºä¸ºâ€œæŸæŸ æ¯”èµ›â€ï¼‰
    // monthFrom: 1-12
    // monthTo: 1-12
    // startTime: "12:00"
    // endTime: "13:00"
    // dates: ["YYYY-MM-DD", ...]  // ä¿®æ”¹1ï¼šå¿…é¡»å®Œæ•´å¹´æœˆæ—¥
    // colorMode: "blue" | "red"   // ä¿®æ”¹2ï¼šé«˜äº®é¢œè‰²
    // place: string
    // note: string
    let state = {
      view: "course",
      items: [],
      selectedId: null
    };

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === "object"){
            state = { ...state, ...parsed };
          }
        }
      }catch(e){}
      // åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼ˆå¦‚æœç©ºï¼‰
      if(!Array.isArray(state.items)) state.items = [];
      if(!state.view) state.view = "course";
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    /***********************
     * UIï¼šåˆ—è¡¨æ¸²æŸ“
     ***********************/
    const $ = (id)=>document.getElementById(id);

    function formatMonthRange(mf, mt){
      if(!mf && !mt) return "æœˆä»½èŒƒå›´æœªè®¾ç½®";
      if(mf && mt) return `${mf}æœˆ â†’ ${mt}æœˆ`;
      if(mf) return `${mf}æœˆèµ·`;
      return `è‡³${mt}æœˆ`;
    }

    function formatDatesShort(dates){
      if(!dates || dates.length===0) return "æœªé€‰æ—¥æœŸ";
      // æ˜¾ç¤ºæœ€è¿‘ 3 ä¸ª
      const arr = [...dates].sort();
      const head = arr.slice(0,3).join("ã€");
      return arr.length<=3 ? head : `${head}â€¦ï¼ˆå…±${arr.length}å¤©ï¼‰`;
    }

    function itemDisplayTitle(it){
      // ä¿®æ”¹6ï¼šæ¯”èµ›æ˜¾ç¤ºä¸º â€œæŸæŸ + å›ºå®šâ€˜æ¯”èµ›â€™â€
      if(it.type === "match"){
        const name = (it.title || "").trim() || "ï¼ˆæœªå‘½åï¼‰";
        return `${name} æ¯”èµ›`;
      }
      return (it.title || "").trim() || "ï¼ˆæœªå‘½åè¯¾ç¨‹ï¼‰";
    }

    function badgeText(it){
      // ä¿®æ”¹3ï¼šæŒ‰æ ‡ç­¾æ˜¾ç¤ºï¼šè¯¾ç¨‹/æ¯”èµ›
      return it.type === "match" ? "æ¯”èµ›" : "è¯¾ç¨‹";
    }

    function badgeClass(it){
      return it.type === "match" ? "match" : "course";
    }

    function renderList(){
      const list = $("itemList");
      list.innerHTML = "";

      const items = state.items.filter(x => x.type === state.view);
      if(items.length === 0){
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "æš‚æ— æ¡ç›®ã€‚ç‚¹å³ä¸Šè§’â€œæ–°å¢â€ã€‚";
        list.appendChild(div);
        $("btnDelete").disabled = true;
        return;
      }

      items.forEach(it=>{
        const card = document.createElement("div");
        card.className = "cardItem" + (state.selectedId === it.id ? " active" : "");
        card.onclick = ()=>{
          state.selectedId = it.id;
          save();
          render();
        };

        const badge = document.createElement("span");
        badge.className = `badge ${badgeClass(it)}`;
        badge.textContent = badgeText(it); // ä¿®æ”¹3

        const title = document.createElement("div");
        title.className = "itemTitle";
        title.textContent = itemDisplayTitle(it);

        const sub = document.createElement("div");
        sub.className = "itemSub";
        const p1 = document.createElement("span");
        p1.textContent = formatMonthRange(it.monthFrom, it.monthTo); // ä¿®æ”¹5ï¼šä¼šç”±é€‰æ‹©æ¡†ç”Ÿæˆ
        const p2 = document.createElement("span");
        // ä¿®æ”¹4ï¼šæ˜¾ç¤ºå¼€å§‹/ç»“æŸ
        const st = it.startTime ? `å¼€å§‹ ${it.startTime}` : "å¼€å§‹æœªè®¾";
        const et = it.endTime ? `ç»“æŸ ${it.endTime}` : "ç»“æŸæœªè®¾";
        p2.textContent = `${st} ï½œ ${et}`;
        const p3 = document.createElement("span");
        p3.textContent = formatDatesShort(it.dates);

        sub.appendChild(p1);
        sub.appendChild(p2);
        sub.appendChild(p3);

        card.appendChild(badge);
        card.appendChild(title);
        card.appendChild(sub);
        list.appendChild(card);
      });

      $("btnDelete").disabled = !state.selectedId || !state.items.find(x=>x.id===state.selectedId && x.type===state.view);
    }

    /***********************
     * UIï¼šè¯¦æƒ…æ¸²æŸ“
     ***********************/
    function monthSelectHTML(id, value){
      const opts = [];
      opts.push(`<option value="">â€”</option>`);
      for(let i=1;i<=12;i++){
        opts.push(`<option value="${i}" ${String(value)===String(i)?"selected":""}>${i}æœˆ</option>`);
      }
      return `<select id="${id}">${opts.join("")}</select>`;
    }

    function timeInput(id, value){
      const v = value || "";
      return `<input id="${id}" type="time" value="${escapeHtml(v)}" />`;
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function renderDetail(){
      const area = $("detailArea");
      const it = state.items.find(x=>x.id===state.selectedId);

      if(!it || it.type !== state.view){
        area.innerHTML = `<div class="empty">è¯·é€‰æ‹©å·¦ä¾§ä¸€ä¸ªæ¡ç›®ï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’â€œæ–°å¢â€ã€‚</div>`;
        return;
      }

      // ä¿®æ”¹6ï¼šæ¯”èµ›åç§°è¾“å…¥æ¡† + å›ºå®šâ€œæ¯”èµ›â€
      // è¯¾ç¨‹ï¼šæ™®é€šè¾“å…¥æ¡†
      const titleField = it.type === "match"
        ? `
          <div class="field">
            <div class="label">æ¯”èµ›åç§°ï¼ˆå¯è¾“å…¥ï¼Œä¹Ÿå¯ç‚¹é€‰å†å²ï¼‰</div>
            <div class="inline">
              <input id="titleInput" list="titleHistory" placeholder="ä¾‹å¦‚ï¼šæ ¡é˜Ÿ / è”èµ› / å‹è°Š" value="${escapeHtml(it.title||"")}" />
              <span class="fixedWord">æ¯”èµ›</span>
            </div>
            <datalist id="titleHistory"></datalist>
            <div class="mini">æç¤ºï¼šè¾“å…¥æ¡†é‡Œä¼šå‡ºç°ä½ æ›¾ç»è®°å½•è¿‡çš„è¯¾ç¨‹/æ¯”èµ›åç§°ï¼Œæ–¹ä¾¿å¤ç”¨ã€‚</div>
          </div>
        `
        : `
          <div class="field">
            <div class="label">è¯¾ç¨‹åç§°</div>
            <input id="titleInput" placeholder="ä¾‹å¦‚ï¼šç¯®çƒè¯¾ / æ•°å­¦è¡¥ä¹ " value="${escapeHtml(it.title||"")}" />
          </div>
        `;

      // ä¿®æ”¹5ï¼šæœˆä»½èŒƒå›´ä¸¤ä¸ªé€‰æ‹©æ¡†ï¼ˆå¼€å§‹æœˆ/ç»“æŸæœˆï¼‰
      const monthRange = `
        <div class="row">
          <div class="field">
            <div class="label">å¼€å§‹æœˆä»½</div>
            ${monthSelectHTML("monthFrom", it.monthFrom)}
          </div>
          <div class="field">
            <div class="label">ç»“æŸæœˆä»½</div>
            ${monthSelectHTML("monthTo", it.monthTo)}
          </div>
        </div>
      `;

      // ä¿®æ”¹4ï¼šå¼€å§‹/ç»“æŸæ—¶é—´æ ‡ç­¾
      const timeRange = `
        <div class="row">
          <div class="field">
            <div class="label">å¼€å§‹æ—¶é—´</div>
            ${timeInput("startTime", it.startTime)}
          </div>
          <div class="field">
            <div class="label">ç»“æŸæ—¶é—´</div>
            ${timeInput("endTime", it.endTime)}
          </div>
        </div>
      `;

      const dateBox = `
        <div class="infoBox">
          <div class="left">ğŸ“… ç‚¹å‡»çœŸå®æ—¥å†å¤šé€‰ä¸Šè¯¾æ—¥æœŸ</div>
          <div class="pill" id="pickedCount">${(it.dates?.length||0)} å¤©</div>
        </div>
        <div class="mini">æ—¥æœŸä¼šä¿å­˜ä¸º <b>YYYY-MM-DD</b>ï¼ˆå®Œæ•´å¹´æœˆæ—¥ï¼‰ã€‚</div>
      `;

      const placeNote = `
        <div class="row">
          <div class="field">
            <div class="label">åœ°ç‚¹</div>
            <input id="place" placeholder="ä¾‹å¦‚ï¼šLightning Event Center / å­¦æ ¡ä½“è‚²é¦†" value="${escapeHtml(it.place||"")}" />
          </div>
          <div class="field">
            <div class="label">æ ‡è®°é¢œè‰²ï¼ˆç”¨äºæ—¥å†é«˜äº®ï¼‰</div>
            <select id="colorMode">
              <option value="blue" ${it.colorMode==="blue"?"selected":""}>è“åº•ç™½å­—</option>
              <option value="red" ${it.colorMode==="red"?"selected":""}>çº¢åº•ç™½å­—</option>
            </select>
          </div>
        </div>

        <div class="field" style="margin-top:12px;">
          <div class="label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œå°½é‡ä¸€è¡Œï¼‰</div>
          <textarea id="note" placeholder="ä¾‹å¦‚ï¼šå¸¦æ°´å£¶/çƒé‹ï¼›æˆ–é›†åˆåœ°ç‚¹â€¦">${escapeHtml(it.note||"")}</textarea>
        </div>
      `;

      area.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <span class="badge ${badgeClass(it)}">${badgeText(it)}</span>
            <div style="margin-top:8px; font-weight:1000; font-size:20px;">${escapeHtml(itemDisplayTitle(it))}</div>
          </div>
          <button class="btn secondary small" id="btnOpenCal" type="button">é€‰æ‹©æ—¥æœŸ</button>
        </div>

        <div style="margin-top:14px;">${titleField}</div>
        ${monthRange}
        ${timeRange}
        ${dateBox}
        ${placeNote}

        <div class="btnRow">
          <button class="btn secondary small" id="btnDup" type="button">å¤åˆ¶ä¸€ä»½</button>
          <button class="btn small" id="btnDone" type="button">å®Œæˆ</button>
        </div>
      `;

      // å¡«å……å†å²ï¼ˆä¿®æ”¹6ï¼‰
      const history = collectTitleHistory();
      const dl = document.getElementById("titleHistory");
      if(dl){
        dl.innerHTML = history.map(t => `<option value="${escapeHtml(t)}"></option>`).join("");
      }

      // ç»‘å®šäº‹ä»¶ï¼šè‡ªåŠ¨ä¿å­˜
      bindDetailEvents(it);
    }

    function collectTitleHistory(){
      // å†å²ï¼šæŠŠæ‰€æœ‰è¯¾ç¨‹å + æ¯”èµ›åéƒ½ä½œä¸ºå»ºè®®ï¼ˆå»é‡ï¼‰
      const set = new Set();
      for(const it of state.items){
        const t = (it.title||"").trim();
        if(t) set.add(t);
      }
      return Array.from(set).slice(0, 50);
    }

    function bindDetailEvents(it){
      const titleInput = document.getElementById("titleInput");
      const monthFrom = document.getElementById("monthFrom");
      const monthTo = document.getElementById("monthTo");
      const startTime = document.getElementById("startTime");
      const endTime = document.getElementById("endTime");
      const place = document.getElementById("place");
      const note = document.getElementById("note");
      const colorMode = document.getElementById("colorMode");
      const pickedCount = document.getElementById("pickedCount");
      const btnOpenCal = document.getElementById("btnOpenCal");
      const btnDup = document.getElementById("btnDup");
      const btnDone = document.getElementById("btnDone");

      function updateAndSave(){
        it.title = titleInput ? titleInput.value : it.title;
        it.monthFrom = monthFrom && monthFrom.value ? Number(monthFrom.value) : "";
        it.monthTo = monthTo && monthTo.value ? Number(monthTo.value) : "";
        it.startTime = startTime ? startTime.value : it.startTime;
        it.endTime = endTime ? endTime.value : it.endTime;
        it.place = place ? place.value : it.place;
        it.note = note ? note.value : it.note;
        it.colorMode = colorMode ? colorMode.value : it.colorMode;

        // åŸºæœ¬çº é”™ï¼šç»“æŸæ—¶é—´æ—©äºå¼€å§‹æ—¶é—´æ—¶ä¸å¼ºåˆ¶æ‹¦ï¼ˆé¿å…æ‰“æ–­ï¼‰
        // ç”¨æˆ·å¯è‡ªè¡Œè°ƒæ•´

        save();
        renderList();
        // åŒæ­¥æ ‡é¢˜
        const areaTitle = $("detailArea").querySelector("div[style*='font-weight:1000']");
        if(areaTitle) areaTitle.textContent = itemDisplayTitle(it);
        if(pickedCount) pickedCount.textContent = `${(it.dates?.length||0)} å¤©`;
      }

      [titleInput, monthFrom, monthTo, startTime, endTime, place, note, colorMode].forEach(el=>{
        if(!el) return;
        el.addEventListener("input", updateAndSave);
        el.addEventListener("change", updateAndSave);
      });

      if(btnOpenCal){
        btnOpenCal.onclick = ()=> openCalendar(it);
      }
      if(btnDup){
        btnDup.onclick = ()=>{
          const copy = JSON.parse(JSON.stringify(it));
          copy.id = uid();
          // å¤åˆ¶åæ ‡é¢˜ç•¥æ”¹ï¼Œé¿å…å®Œå…¨ä¸€æ ·éš¾åˆ†
          // æ¯”èµ›åªå­˜â€œæŸæŸâ€ï¼Œè¯¾ç¨‹å­˜å®Œæ•´
          if(copy.type === "course"){
            copy.title = (copy.title || "è¯¾ç¨‹") + "ï¼ˆå¤åˆ¶ï¼‰";
          }else{
            copy.title = (copy.title || "æ¯”èµ›") + "ï¼ˆå¤åˆ¶ï¼‰";
          }
          state.items.unshift(copy);
          state.selectedId = copy.id;
          save();
          render();
        };
      }
      if(btnDone){
        btnDone.onclick = ()=>{
          // ä¸è·³è½¬ï¼Œä¸å¼¹çª—ï¼šä»…ç»™ä¸€ä¸ªè§†è§‰ç¡®è®¤ï¼ˆè½»é‡ï¼‰
          btnDone.textContent = "å·²ä¿å­˜ âœ“";
          setTimeout(()=> btnDone.textContent = "å®Œæˆ", 900);
        };
      }
    }

    /***********************
     * æ—¥å†ï¼ˆä¿®æ”¹1 & ä¿®æ”¹2ï¼‰
     ***********************/
    let calCtx = {
      item: null,
      y: 0,
      m: 0, // 1-12
      workingDates: new Set()
    };

    function pad2(n){ return String(n).padStart(2,"0"); }
    function ymd(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

    function openCalendar(item){
      calCtx.item = item;
      calCtx.workingDates = new Set(item.dates || []);
      const now = new Date();
      // å¦‚æœå·²æœ‰æ—¥æœŸï¼šé»˜è®¤è·³åˆ°æœ€è¿‘ä¸€ä¸ªæ—¥æœŸçš„æœˆä»½
      if(item.dates && item.dates.length){
        const last = [...item.dates].sort().slice(-1)[0];
        const [yy, mm] = last.split("-").map(Number);
        calCtx.y = yy; calCtx.m = mm;
      }else{
        calCtx.y = now.getFullYear();
        calCtx.m = now.getMonth()+1;
      }
      $("modalTitle").textContent = item.type === "match" ? "å¤šé€‰æ¯”èµ›æ—¥æœŸ" : "å¤šé€‰ä¸Šè¯¾æ—¥æœŸ";
      renderCalendar();
      $("modalMask").classList.add("show");
      $("modalMask").setAttribute("aria-hidden","false");
    }

    function closeCalendar(){
      $("modalMask").classList.remove("show");
      $("modalMask").setAttribute("aria-hidden","true");
    }

    function renderCalendar(){
      // ä¿®æ”¹1ï¼šé¡¶éƒ¨æ˜¾ç¤ºå¹´/æœˆ
      $("ymLabel").textContent = `${calCtx.y} / ${pad2(calCtx.m)}`;

      const grid = $("calGrid");
      grid.innerHTML = "";

      const first = new Date(calCtx.y, calCtx.m - 1, 1);
      const startDow = first.getDay(); // 0-6
      const daysInMonth = new Date(calCtx.y, calCtx.m, 0).getDate();
      const prevMonthDays = new Date(calCtx.y, calCtx.m - 1, 0).getDate();

      // 42æ ¼ï¼ˆ6è¡Œï¼‰
      for(let i=0;i<42;i++){
        const cell = document.createElement("div");
        cell.className = "dayCell";

        let dayNum, inMonth, y=calCtx.y, m=calCtx.m;

        if(i < startDow){
          // ä¸Šæœˆ
          inMonth = false;
          dayNum = prevMonthDays - (startDow - 1 - i);
          const prev = new Date(calCtx.y, calCtx.m - 2, dayNum);
          y = prev.getFullYear();
          m = prev.getMonth()+1;
          cell.classList.add("muted");
        }else if(i >= startDow + daysInMonth){
          // ä¸‹æœˆ
          inMonth = false;
          dayNum = i - (startDow + daysInMonth) + 1;
          const next = new Date(calCtx.y, calCtx.m, dayNum);
          y = next.getFullYear();
          m = next.getMonth()+1;
          cell.classList.add("muted");
        }else{
          inMonth = true;
          dayNum = i - startDow + 1;
        }

        const key = ymd(y,m,dayNum);

        // ä¿®æ”¹2ï¼šå·²é€‰æ—¥æœŸç”¨è‰²å—é«˜äº®ï¼ˆè“/çº¢åº•ç™½å­—ï¼‰ï¼Œä¸å†å°ç‚¹
        if(calCtx.workingDates.has(key)){
          const mode = (calCtx.item && calCtx.item.colorMode) ? calCtx.item.colorMode : "blue";
          if(mode === "red") cell.classList.add("selectedRed");
          else cell.classList.add("selectedBlue");
        }

        const num = document.createElement("div");
        num.className = "dayNum";
        num.textContent = String(dayNum);
        cell.appendChild(num);

        cell.onclick = ()=>{
          // ç‚¹å‡»ä»»ä½•æ ¼å­éƒ½å…è®¸é€‰æ‹©ï¼šä¼šè®°å½•çœŸå®å¹´æœˆæ—¥ï¼ˆä¿®æ”¹1ï¼‰
          if(calCtx.workingDates.has(key)){
            calCtx.workingDates.delete(key);
          }else{
            calCtx.workingDates.add(key);
          }
          renderCalendar();
        };

        grid.appendChild(cell);
      }

      $("calSummary").textContent = `å·²é€‰ ${calCtx.workingDates.size} å¤©`;
    }

    $("modalClose").onclick = closeCalendar;
    $("modalMask").addEventListener("click", (e)=>{
      if(e.target === $("modalMask")) closeCalendar();
    });

    $("prevMonth").onclick = ()=>{
      calCtx.m -= 1;
      if(calCtx.m === 0){ calCtx.m = 12; calCtx.y -= 1; }
      renderCalendar();
    };
    $("nextMonth").onclick = ()=>{
      calCtx.m += 1;
      if(calCtx.m === 13){ calCtx.m = 1; calCtx.y += 1; }
      renderCalendar();
    };
    $("calConfirm").onclick = ()=>{
      if(!calCtx.item) return closeCalendar();
      calCtx.item.dates = Array.from(calCtx.workingDates).sort();
      save();
      closeCalendar();
      render();
    };

    /***********************
     * é¡¶éƒ¨æŒ‰é’®é€»è¾‘
     ***********************/
    $("tabCourse").onclick = ()=>{
      state.view = "course";
      // è‹¥å½“å‰é€‰ä¸­ä¸æ˜¯è¯¾ç¨‹ï¼Œåˆ™å–æ¶ˆé€‰ä¸­ï¼ˆé¿å…åˆ é™¤è¯¯åˆ ï¼‰
      const it = state.items.find(x=>x.id===state.selectedId);
      if(it && it.type !== "course") state.selectedId = null;
      save();
      render();
    };
    $("tabMatch").onclick = ()=>{
      state.view = "match";
      const it = state.items.find(x=>x.id===state.selectedId);
      if(it && it.type !== "match") state.selectedId = null;
      save();
      render();
    };

    function addNew(){
      const now = new Date();
      const item = {
        id: uid(),
        type: state.view,         // course/match
        title: "",
        monthFrom: "",
        monthTo: "",
        startTime: "12:00",
        endTime: "13:00",
        dates: [],
        colorMode: "blue",
        place: "",
        note: ""
      };
      // æ–°å»ºæ—¶ï¼šé»˜è®¤æœˆä»½=å½“å‰æœˆ
      item.monthFrom = now.getMonth()+1;
      item.monthTo = now.getMonth()+1;

      state.items.unshift(item);
      state.selectedId = item.id;
      save();
      render();
    }

    $("btnAdd").onclick = addNew;

    $("btnDelete").onclick = ()=>{
      const it = state.items.find(x=>x.id===state.selectedId);
      if(!it || it.type !== state.view) return;

      const ok = confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ¡ç›®å—ï¼Ÿï¼ˆæ— æ³•æ’¤é”€ï¼‰");
      if(!ok) return;

      state.items = state.items.filter(x=>x.id !== it.id);
      state.selectedId = null;
      save();
      render();
    };

    $("btnClear").onclick = ()=>{
      const ok = confirm("ç¡®å®šæ¸…ç©ºæœ¬æœºæ‰€æœ‰æ•°æ®å—ï¼Ÿï¼ˆåªæ¸…æµè§ˆå™¨æœ¬åœ°ï¼Œä¸å½±å“ GitHub æ–‡ä»¶ï¼‰");
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      state.items = [];
      state.selectedId = null;
      save();
      render();
    };

    $("btnExport").onclick = ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "lifehub_backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    /***********************
     * render
     ***********************/
    function render(){
      // tabs UI
      $("tabCourse").classList.toggle("active", state.view==="course");
      $("tabMatch").classList.toggle("active", state.view==="match");

      renderList();
      renderDetail();
    }

    /***********************
     * å¯åŠ¨
     ***********************/
    load();

    // å¦‚æœç¬¬ä¸€æ¬¡ç©ºï¼šç»™ä¸¤ä¸ªç¤ºä¾‹ï¼ˆä¾¿äºä½ éªŒè¯ç•Œé¢ï¼‰
    if(state.items.length === 0){
      const sampleCourse = {
        id: uid(),
        type: "course",
        title: "ç¯®çƒè¯¾",
        monthFrom: 1,
        monthTo: 3,
        startTime: "12:00",
        endTime: "13:00",
        dates: [],
        colorMode: "blue",
        place: "",
        note: ""
      };
      const sampleMatch = {
        id: uid(),
        type: "match",
        title: "æ ¡é˜Ÿ",
        monthFrom: 1,
        monthTo: 1,
        startTime: "09:00",
        endTime: "11:00",
        dates: [],
        colorMode: "red",
        place: "",
        note: ""
      };
      state.items = [sampleCourse, sampleMatch];
      state.view = "course";
      state.selectedId = sampleCourse.id;
      save();
    }

    render();
  </script>
</body>
</html>
