<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life-Hub è¯¾ç¨‹ä¸ä¹ æƒ¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .past-event { opacity: 0.6; filter: grayscale(1); }
        .current-event { border: 2px solid #2563eb; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-100 pb-24">
    <div id="alertBar" class="hidden bg-red-600 text-white p-3 text-center sticky top-0 z-20 font-bold shadow-lg">
        </div>

    <div class="p-4">
        <h1 class="text-xl font-bold text-center mb-4">è¯¾ç¨‹ä¸æ´»åŠ¨å®‰æ’</h1>
        
        <div class="flex justify-between bg-white p-1 rounded-xl shadow-sm mb-4 overflow-x-auto">
            <button onclick="setDay(1)" class="day-btn flex-1 py-2 rounded-lg text-sm" data-day="1">å‘¨ä¸€</button>
            <button onclick="setDay(2)" class="day-btn flex-1 py-2 rounded-lg text-sm" data-day="2">å‘¨äºŒ</button>
            <button onclick="setDay(3)" class="day-btn flex-1 py-2 rounded-lg text-sm" data-day="3">å‘¨ä¸‰</button>
            <button onclick="setDay(4)" class="day-btn flex-1 py-2 rounded-lg text-sm" data-day="4">å‘¨å››</button>
            <button onclick="setDay(5)" class="day-btn flex-1 py-2 rounded-lg text-sm" data-day="5">å‘¨äº”</button>
            <button onclick="setDay(6)" class="day-btn flex-1 py-2 rounded-lg text-sm" data-day="6">å‘¨å…­</button>
            <button onclick="setDay(0)" class="day-btn flex-1 py-2 rounded-lg text-sm" data-day="0">å‘¨æ—¥</button>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm mb-6 space-y-3">
            <input type="text" id="courseName" placeholder="è¯¾ç¨‹/æ´»åŠ¨åç§° (å¦‚ï¼šæ¸¸æ³³)" class="w-full p-2 border rounded-lg">
            <div class="flex gap-2">
                <div class="flex-1">
                    <label class="text-[10px] text-gray-400">å¼€å§‹æ—¶é—´</label>
                    <input type="time" id="startTime" class="w-full p-2 border rounded-lg">
                </div>
                <div class="flex-1">
                    <label class="text-[10px] text-gray-400">ç»“æŸæ—¶é—´</label>
                    <input type="time" id="endTime" class="w-full p-2 border rounded-lg">
                </div>
            </div>
            <input type="text" id="location" placeholder="åœ°ç‚¹/æ•™å®¤" class="w-full p-2 border rounded-lg text-sm">
            <button onclick="saveCourse()" class="w-full bg-blue-600 text-white py-2 rounded-xl font-bold">æ·»åŠ å®‰æ’</button>
        </div>

        <div id="courseList" class="space-y-3">
            </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 text-gray-400">
        <a href="price.html" class="flex flex-col items-center">
            <span class="text-[10px]">ç”Ÿæ´»æ¯”ä»·</span>
        </a>
        <a href="schedule.html" class="flex flex-col items-center text-blue-600">
            <span class="text-[10px] font-bold">è¯¾ç¨‹å®‰æ’</span>
        </a>
    </div>

    <script>
        let courses = JSON.parse(localStorage.getItem('family_courses') || '[]');
        let currentViewDay = new Date().getDay(); // é»˜è®¤æ˜¾ç¤ºä»Šå¤©

        function saveCourse() {
            const name = document.getElementById('courseName').value;
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const loc = document.getElementById('location').value;

            if(!name || !start || !end) return alert("è¯·å¡«å†™åç§°å’Œæ—¶é—´");

            courses.push({
                id: Date.now(),
                day: currentViewDay,
                name, start, end, loc
            });
            localStorage.setItem('family_courses', JSON.stringify(courses));
            renderCourses();
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('courseName').value = '';
        }

        function setDay(d) {
            currentViewDay = d;
            renderCourses();
        }

        function renderCourses() {
            const listDiv = document.getElementById('courseList');
            const btns = document.querySelectorAll('.day-btn');
            listDiv.innerHTML = '';

            // æ›´æ–°æŒ‰é’®æ ·å¼
            btns.forEach(btn => {
                if(parseInt(btn.dataset.day) === currentViewDay) {
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                }
            });

            // è¿‡æ»¤å¹¶æ’åºï¼ˆæŒ‰å¼€å§‹æ—¶é—´ï¼‰
            let todays = courses.filter(c => c.day === currentViewDay)
                                .sort((a, b) => a.start.localeCompare(b.start));

            const now = new Date();
            const nowTimeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

            todays.forEach(c => {
                let statusClass = "";
                let statusLabel = "";
                
                if (nowTimeStr > c.end) {
                    statusClass = "past-event";
                    statusLabel = " (å·²ç»“æŸ)";
                } else if (nowTimeStr >= c.start && nowTimeStr <= c.end) {
                    statusClass = "current-event shadow-blue-200";
                    statusLabel = " ğŸŸ¢ æ­£åœ¨ä¸Šè¯¾";
                }

                const item = document.createElement('div');
                item.className = `bg-white p-4 rounded-xl shadow-sm flex justify-between items-center transition-all ${statusClass}`;
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-lg">${c.name}<span class="text-xs font-normal text-blue-500">${statusLabel}</span></p>
                        <p class="text-sm text-gray-500">${c.start} - ${c.end}</p>
                        <p class="text-xs text-gray-400">åœ°ç‚¹: ${c.loc || 'æœªè®¾å®š'}</p>
                    </div>
                    <button onclick="deleteCourse(${c.id})" class="text-red-400 text-xs">åˆ é™¤</button>
                `;
                listDiv.appendChild(item);
            });

            checkReminder();
        }

        function deleteCourse(id) {
            if(confirm("ç¡®å®šåˆ é™¤è¯¥å®‰æ’ï¼Ÿ")) {
                courses = courses.filter(c => c.id !== id);
                localStorage.setItem('family_courses', JSON.stringify(courses));
                renderCourses();
            }
        }

        function checkReminder() {
            const alertBar = document.getElementById('alertBar');
            const now = new Date();
            const todayNum = now.getDay();
            
            // åªåœ¨ä»Šå¤©çš„æ•°æ®é‡Œæ‰¾
            let upcoming = courses.filter(c => c.day === todayNum).sort((a,b) => a.start.localeCompare(b.start));
            
            let found = false;
            for(let c of upcoming) {
                let [h, m] = c.start.split(':').map(Number);
                let startTime = new Date();
                startTime.setHours(h, m, 0);
                
                let diff = (startTime - now) / 1000 / 60; // åˆ†é’Ÿå·®

                if(diff > 0 && diff <= 30) {
                    alertBar.innerText = `è·ç¦» ${c.name} å¼€å§‹è¿˜æœ‰ ${Math.floor(diff)} åˆ†é’Ÿ`;
                    alertBar.classList.remove('hidden');
                    found = true;
                    break;
                }
            }
            if(!found) alertBar.classList.add('hidden');
        }

        // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡çŠ¶æ€
        setInterval(renderCourses, 60000);
        renderCourses();
    </script>
</body>
</html>
